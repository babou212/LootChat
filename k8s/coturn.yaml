apiVersion: v1
kind: ConfigMap
metadata:
  name: coturn-config
  namespace: lootchat
data:
  turnserver.conf: |
    # TURN server configuration
    listening-port=3478
    tls-listening-port=5349
    
    # Use fingerprint in TURN messages
    fingerprint
    
    # Use long-term credential mechanism
    lt-cred-mech
    
    # Realm for the TURN server (should match your domain)
    realm=dylancree.com
    
    # Server name
    server-name=turn.dylancree.com
    
    # Log to stdout for Kubernetes
    log-file=stdout
    
    # Verbose logging (can be reduced in production)
    verbose
    
    # Disable CLI
    no-cli
    
    # Allow peers on the same machine (important for single-node clusters)
    no-multicast-peers
    
    # Relay IP range - internal cluster network
    # This allows relaying within the cluster
    allowed-peer-ip=10.0.0.0-10.255.255.255
    allowed-peer-ip=172.16.0.0-172.31.255.255
    allowed-peer-ip=192.168.0.0-192.168.255.255
    
    # Deny localhost relay
    denied-peer-ip=127.0.0.0-127.255.255.255
    
    # Maximum allocations per user
    user-quota=12
    total-quota=1200
    
    # Max bandwidth per session (in bytes per second)
    max-bps=1000000
    
    # Stale nonce lifetime (in seconds)
    stale-nonce=600
    
    # Min and max ports for relay (these should match the NodePort range or be exposed)
    min-port=49152
    max-port=65535
    
    # Prometheus metrics (optional)
    prometheus
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coturn
  namespace: lootchat
  labels:
    app: coturn
spec:
  replicas: 1
  selector:
    matchLabels:
      app: coturn
  template:
    metadata:
      labels:
        app: coturn
    spec:
      # Use host network for TURN to properly relay media
      # This is required for the TURN server to correctly advertise its external IP
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      # Pin to worker-1 since we hardcode its IP in TURN URLs
      nodeSelector:
        kubernetes.io/hostname: lootchat-worker-1
      containers:
      - name: coturn
        image: coturn/coturn:4.6.2-alpine
        args:
          - "-c"
          - "/etc/coturn/turnserver.conf"
          - "--user=$(TURN_USERNAME):$(TURN_PASSWORD)"
          - "--static-auth-secret=$(TURN_STATIC_AUTH_SECRET)"
          - "--external-ip=$(HOST_IP)"
        env:
        - name: TURN_USERNAME
          valueFrom:
            secretKeyRef:
              name: lootchat-secrets
              key: TURN_USERNAME
        - name: TURN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: lootchat-secrets
              key: TURN_PASSWORD
        - name: TURN_STATIC_AUTH_SECRET
          valueFrom:
            secretKeyRef:
              name: lootchat-secrets
              key: TURN_STATIC_AUTH_SECRET
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        ports:
        - containerPort: 3478
          protocol: UDP
          name: turn-udp
        - containerPort: 3478
          protocol: TCP
          name: turn-tcp
        - containerPort: 5349
          protocol: TCP
          name: turns-tcp
        volumeMounts:
        - name: coturn-config
          mountPath: /etc/coturn
          readOnly: true
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        livenessProbe:
          tcpSocket:
            port: 3478
          initialDelaySeconds: 10
          periodSeconds: 30
          failureThreshold: 3
        readinessProbe:
          tcpSocket:
            port: 3478
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: coturn-config
        configMap:
          name: coturn-config
---
apiVersion: v1
kind: Service
metadata:
  name: coturn
  namespace: lootchat
  labels:
    app: coturn
spec:
  # ClusterIP service for internal reference
  # With hostNetwork, external clients connect directly to node IP on ports 3478/5349
  type: ClusterIP
  selector:
    app: coturn
  ports:
  - name: turn-udp
    port: 3478
    targetPort: 3478
    protocol: UDP
  - name: turn-tcp
    port: 3478
    targetPort: 3478
    protocol: TCP
  - name: turns-tcp
    port: 5349
    targetPort: 5349
    protocol: TCP
---
# Network policy to allow traffic to coturn
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: coturn-network-policy
  namespace: lootchat
spec:
  podSelector:
    matchLabels:
      app: coturn
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow TURN/STUN traffic from anywhere (external clients)
  - ports:
    - port: 3478
      protocol: UDP
    - port: 3478
      protocol: TCP
    - port: 5349
      protocol: TCP
  # Allow relay port range
  - ports:
    - port: 49152
      endPort: 65535
      protocol: UDP
  egress:
  # Allow all egress for relay functionality
  - {}
